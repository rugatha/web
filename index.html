<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BZZFKMJ65Y"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-BZZFKMJ65Y');
  </script>
  <title>Rugatha</title>
  <link rel="icon" type="image/png" href="assets/rugatha-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/rugatha-icon-32.png">
  <link rel="stylesheet" href="shared/styles/theme.css">
  <link rel="stylesheet" href="styles/home.css">
  <style>
    .auth-entry {
      position: static;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      margin: 16px auto 8px;
      padding: 0 16px;
      text-align: center;
      justify-self: center;
      align-self: center;
      grid-column: 1 / -1;
      font-family: "Space Grotesk", "Inter", system-ui, -apple-system, sans-serif;
    }

    .auth-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(0, 0, 0, 0.1);
      color: #1a1a1a;
      font-weight: 700;
      cursor: pointer;
    }

    .auth-button--ghost {
      background: rgba(255, 255, 255, 0.12);
      color: #f0f5f2;
      border-color: rgba(255, 255, 255, 0.3);
    }

    .auth-icon {
      width: 24px;
      height: 24px;
      display: grid;
      place-items: center;
      background: #fff;
      border-radius: 50%;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.08);
    }

    .auth-status {
      font-size: 13px;
      color: #f0f5f2;
      font-weight: 600;
      text-align: center;
      max-width: 240px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.45);
    }

    .google-signin {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      padding: 12px 0 6px;
    }

    .google-signin a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 18px;
      border-radius: 999px;
      background: #ffffff;
      color: #1a1a1a;
      font-weight: 800;
      text-decoration: none;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.22);
    }

    @media (max-width: 720px) {
      .auth-status {
        display: none;
      }
    }
  </style>
  <meta property="og:image" content="https://rugatha.github.io/web/assets/rugatha-banner.jpg">
  <meta name="twitter:image" content="https://rugatha.github.io/web/assets/rugatha-banner.jpg">
  <meta name="twitter:card" content="summary_large_image">

</head>
<body>
  <div class="page">
    <main class="hub" aria-label="Rugatha portals">
      <section class="portals" aria-label="Rugatha portals">
        <div class="portal-grid">
          <a class="portal" href="deities/index.html">
            <span class="portal-glyph"><img src="assets/icons/deities-icon.png" alt="Deities icon" class="portal-icon"></span>
            <div class="portal-copy">
              <span class="portal-title">Deities</span>
              <span class="portal-title">ç¥ç¥‡ä¿¡ä»°</span>
            </div>
          </a>
          <a class="portal" href="emperors/index.html">
            <span class="portal-glyph"><img src="assets/icons/emperors-icon.png" alt="Emperors icon" class="portal-icon"></span>
            <div class="portal-copy">
              <span class="portal-title">Emperors</span>
              <span class="portal-title">æ­·ä»»çš‡å¸</span>
            </div>
          </a>
          <a class="portal" href="map/index.html">
            <span class="portal-glyph"><img src="assets/icons/map-icon.png" alt="Map icon" class="portal-icon"></span>
            <div class="portal-copy">
              <span class="portal-title">Map</span>
              <span class="portal-title">å“å°¼æ£®åœ°åœ–</span>
            </div>
          </a>
          <a class="portal" href="timeline/index.html">
            <span class="portal-glyph"><img src="assets/icons/history-icon.png" alt="History icon" class="portal-icon"></span>
            <div class="portal-copy">
              <span class="portal-title">History</span>
              <span class="portal-title">å“å°¼æ£®å²</span>
            </div>
          </a>
          <a class="portal" href="character_main_page/index.html">
            <span class="portal-glyph"><img src="assets/icons/characters-icon.png" alt="Characters icon" class="portal-icon"></span>
            <div class="portal-copy">
              <span class="portal-title">Characters</span>
              <span class="portal-title">ç©å®¶/éç©å®¶è§’è‰²</span>
            </div>
          </a>
          <a class="portal" href="campaigns/index.html">
            <span class="portal-glyph"><img src="assets/icons/campaigns-icon.png" alt="Campaigns icon" class="portal-icon"></span>
            <div class="portal-copy">
              <span class="portal-title">Campaigns</span>
              <span class="portal-title">å„åœ˜åœ˜éŒ„</span>
            </div>
          </a>
        </div>
      </section>

      <section class="about-link" aria-label="About Rugatha">
        <a href="about-us/index.html" class="about-link-card">
          <div class="about-link-copy about-link-copy--centered">
            <span class="about-link-title">About Us</span>
            <span class="about-link-title">é—œæ–¼ Rugatha</span>
          </div>
        </a>
        <a href="member/index.html" class="about-link-card" id="adventurer-journal-link">
          <div class="about-link-copy about-link-copy--centered">
            <span class="about-link-title">Adventurer's Journal</span>
            <span class="about-link-title">å†’éšªè€…æ—¥èªŒ</span>
          </div>
        </a>
        <a href="character_card/index.html" class="about-link-card">
          <div class="about-link-copy about-link-copy--centered">
            <span class="about-link-title">Character Card Generator</span>
            <span class="about-link-title">è§’è‰²å¡è£½ä½œå™¨</span>
          </div>
        </a>
      </section>

      <section class="auth-entry" aria-label="Account">
        <button class="auth-button" id="google-login" type="button" aria-label="Sign in with Google">
          <span class="auth-icon" aria-hidden="true">
            <svg viewBox="0 0 256 262" width="18" height="18" role="presentation" focusable="false">
              <path fill="#4285F4" d="M255.9 133.5c0-11.1-.9-22.5-2.9-33.5H130v63.4h70.3c-3 16.1-12.2 30.1-25.9 39.4v32.6h41.8c24.5-22.6 39.7-56.1 39.7-101.9z"/>
              <path fill="#34A853" d="M130 261.1c35.1 0 64.6-11.6 86.2-31.5l-41.8-32.6c-11.6 7.8-26.5 12.4-44.4 12.4-34.1 0-63-23-73.3-53.8H13.6v33.8C35.4 230.6 79.9 261.1 130 261.1z"/>
              <path fill="#FBBC05" d="M56.7 155.6c-2.7-8.1-4.2-16.8-4.2-25.6s1.6-17.5 4.2-25.6V70.6H13.6C4.9 88.2 0 108.1 0 130s4.9 41.8 13.6 59.4l43.1-33.8z"/>
              <path fill="#EA4335" d="M130 51.9c19.1 0 36.3 6.6 49.8 19.6l37.3-37.3C194.5 12.7 165.1 0 130 0 79.9 0 35.4 30.5 13.6 70.6l43.1 33.8C67 74.9 95.9 51.9 130 51.9z"/>
            </svg>
          </span>
          <span class="auth-label">Sign in</span>
        </button>
        <button class="auth-button auth-button--ghost" id="google-logout" type="button" aria-label="Sign out" disabled>
          <span class="auth-label">Sign out</span>
        </button>
        <div class="auth-status" id="auth-status" aria-live="polite">Google login</div>
      </section>

      <section class="bulletin" aria-label="Rugatha bulletin">
        <div class="bulletin-inner">
          <h1 class="bulletin-title">æœ€æ–°å…¬å‘Š NEWS</h1>
          <!--<div class="bulletin-copy">
            <p>2025é¾å±±åœ°ä¸‹åŸ</p>
            <p>ğŸŠå®Œç¾è½å¹•ğŸŠ</p>
          </div>
          <a class="bulletin-media" href="https://www.facebook.com/D3Fest/posts/pfbid06tJjDeXfPsuboPNUtYAXC7AS3pn7eUUYMiu9EiBZyRbaha62VR1TpnXMEX2Nja6Ql">
            <img src="assets/d3-banner-2025.jpg" alt="D3 2025 poster" class="bulletin-image">
          </a>
          <div class="bulletin-divider" aria-hidden="true"></div>-->
          <a class="bulletin-media">
            <img src="assets/rugatha-experience.png" alt="Rugatha experience poster" class="bulletin-image">
          </a>
          <div class="bulletin-copy">
            <p><a href="https://www.surveycake.com/s/WQ7AD">é»æ“Šå ±å2026/2/14è·‘åœ˜é«”é©—ï¼</a></p>
            <p><a href="https://www.surveycake.com/s/WQ7AD">Click to sign up for the February 14th 2026 One Shot event!</a></p>
            <p><br></p>
            <p>æˆªæ­¢æ™‚é–“ï¼š2026/2/8 23:59 (å°ç£æ™‚é–“)</p>
            <p>Deadline: February 8th 2026 23:59 (GMT +8)</p>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script src="shared/rugatha.config.js"></script>
  <script src="shared/firebase.config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-auth-compat.js"></script>
  <script type="module" src="shared/auth.js"></script>
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      get,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    const firebaseConfig = window.RUGATHA_FIREBASE_CONFIG || null;
    const firebaseDisabled =
      window.RUGATHA_FEATURE_FLAGS && window.RUGATHA_FEATURE_FLAGS.firebaseEnabled === false;
    const SURVEYCAKE_PREFIX = "https://www.surveycake.com/";
    const ACHIEVEMENTS_CSV_PATH = "member/achievements.csv";
    const ACHIEVEMENT_CODE = "ach_HRitT";

    let auth = null;
    let db = null;
    let currentUser = null;
    let achievementData = null;
    let achievementLoadPromise = null;
    const journalLink = document.getElementById("adventurer-journal-link");

    const parseCsv = (text) => {
      const rows = [];
      let row = [];
      let cell = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i += 1) {
        const char = text[i];
        if (inQuotes) {
          if (char === "\"") {
            if (text[i + 1] === "\"") {
              cell += "\"";
              i += 1;
            } else {
              inQuotes = false;
            }
          } else {
            cell += char;
          }
        } else if (char === "\"") {
          inQuotes = true;
        } else if (char === ",") {
          row.push(cell);
          cell = "";
        } else if (char === "\n") {
          row.push(cell);
          rows.push(row);
          row = [];
          cell = "";
        } else if (char !== "\r") {
          cell += char;
        }
      }
      if (cell.length || row.length) {
        row.push(cell);
        rows.push(row);
      }
      return rows;
    };

    const loadAchievementData = async () => {
      if (achievementLoadPromise) {
        return achievementLoadPromise;
      }
      achievementLoadPromise = (async () => {
        try {
          const response = await fetch(ACHIEVEMENTS_CSV_PATH, { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`Failed to load achievements CSV: ${response.status}`);
          }
          const text = await response.text();
          const rows = parseCsv(text);
          if (!rows.length) return null;
          const headers = rows[0].map((header) => String(header || "").trim());
          const target = rows.slice(1).find((row) => row[0] === ACHIEVEMENT_CODE);
          if (!target) return null;
          const record = {};
          headers.forEach((header, index) => {
            record[header] = target[index] ?? "";
          });
          achievementData = {
            achievement: ACHIEVEMENT_CODE,
            flavorZh: record.flavorZh || "",
            flavorEn: record.flavorEn || "",
            rewards: {
              BadgeSTR: Number(record.STR || 0),
              BadgeDEX: Number(record.DEX || 0),
              BadgeCON: Number(record.CON || 0),
              BadgeINT: Number(record.INT || 0),
              BadgeWIS: Number(record.WIS || 0),
              BadgeCHA: Number(record.CHA || 0)
            }
          };
          return achievementData;
        } catch (error) {
          console.error("Failed to load achievement data", error);
          return null;
        }
      })();
      return achievementLoadPromise;
    };

    const showAchievementToast = (flavorZh, flavorEn) => {
      if (!flavorZh && !flavorEn) return;
      if (!document.body) return;
      const styleId = "rugatha-achievement-toast-style";
      if (!document.getElementById(styleId)) {
        const style = document.createElement("style");
        style.id = styleId;
        style.textContent = `
          .achievement-toast-wrap {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 9999;
            display: grid;
            gap: 10px;
            pointer-events: none;
          }
          .achievement-toast {
            min-width: 220px;
            max-width: 320px;
            background: rgba(248, 250, 252, 0.95);
            color: #1b2a26;
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 14px;
            padding: 12px 14px;
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.35);
            display: grid;
            gap: 6px;
            font-size: 0.85rem;
            line-height: 1.4;
            animation: toast-in 200ms ease-out;
          }
          .achievement-toast .toast-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: rgba(27, 42, 38, 0.7);
          }
          @keyframes toast-in {
            from { transform: translateY(6px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);
      }
      let wrap = document.querySelector(".achievement-toast-wrap");
      if (!wrap) {
        wrap = document.createElement("div");
        wrap.className = "achievement-toast-wrap";
        document.body.appendChild(wrap);
      }
      const toast = document.createElement("div");
      toast.className = "achievement-toast";
      const title = document.createElement("div");
      title.className = "toast-title";
      title.textContent = "89e3939662105c31Ff1a";
      toast.appendChild(title);
      if (flavorZh) {
        const zh = document.createElement("div");
        zh.textContent = flavorZh;
        toast.appendChild(zh);
      }
      if (flavorEn) {
        const en = document.createElement("div");
        en.textContent = flavorEn;
        toast.appendChild(en);
      }
      wrap.appendChild(toast);
      window.setTimeout(() => {
        toast.remove();
        if (wrap && !wrap.children.length) {
          wrap.remove();
        }
      }, 4500);
    };

    const resolveMemberId = async (user) => {
      if (!user || !db) return null;
      const defaultId = user.uid;
      try {
        const snapshot = await get(ref(db, `members/${defaultId}`));
        if (snapshot.exists()) {
          const data = snapshot.val() || {};
          return data.memberId || defaultId;
        }
      } catch (error) {
        console.error("Failed to resolve member id", error);
      }
      return defaultId;
    };

    const awardAchievement = async () => {
      if (!currentUser || !db) return;
      const achievement = await loadAchievementData();
      if (!achievement) return;
      const memberId = await resolveMemberId(currentUser);
      if (!memberId) return;
      const memberRef = ref(db, `members/${memberId}`);
      let awarded = false;
      try {
        const result = await runTransaction(memberRef, (current) => {
          const existing = current || {};
          const existingAchievements = existing.achievements || {};
          if (existingAchievements[achievement.achievement]) {
            return existing;
          }
          awarded = true;
          const nextAchievements = { ...existingAchievements, [achievement.achievement]: true };
          const next = { ...existing, achievements: nextAchievements };
          Object.entries(achievement.rewards || {}).forEach(([key, value]) => {
            const baseValue = Number(existing[key]);
            const safeBase = Number.isFinite(baseValue) ? baseValue : 10;
            const rewardValue = Number.isFinite(value) ? value : 0;
            next[key] = safeBase + rewardValue;
          });
          return next;
        });
        if (result.committed && awarded) {
          showAchievementToast(achievement.flavorZh, achievement.flavorEn);
        }
      } catch (error) {
        console.error("Failed to award achievement", error);
      }
    };

    const setupSurveycakeTracking = () => {
      const links = Array.from(document.querySelectorAll("a[href]")).filter((link) =>
        link.href.startsWith(SURVEYCAKE_PREFIX)
      );
      if (!links.length) return;
      links.forEach((link) => {
        link.addEventListener("click", async (event) => {
          const isPrimaryClick =
            event.button === 0 && !event.metaKey && !event.ctrlKey && !event.shiftKey && !event.altKey;
          if (isPrimaryClick) {
            event.preventDefault();
            await awardAchievement();
            window.location.assign(link.href);
            return;
          }
          awardAchievement();
        });
      });
    };

    if (!firebaseDisabled && firebaseConfig) {
      const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);
      onAuthStateChanged(auth, (user) => {
        currentUser = user || null;
      });
    }

    if (journalLink) {
      journalLink.addEventListener("click", (event) => {
        if (!currentUser) {
          event.preventDefault();
          alert("Please sign in è«‹ç™»å…¥");
        }
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", setupSurveycakeTracking);
    } else {
      setupSurveycakeTracking();
    }
  </script>
</body>
</html>
