<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BZZFKMJ65Y"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-BZZFKMJ65Y');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dranison Map</title>
  <link rel="icon" type="image/png" href="../assets/rugatha-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/rugatha-icon-32.png">
  <link rel="stylesheet" href="../shared/styles/theme.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <link rel="stylesheet" href="styles/map.css">
  <meta property="og:image" content="https://rugatha.github.io/web/assets/rugatha-banner.jpg">
  <meta name="twitter:image" content="https://rugatha.github.io/web/assets/rugatha-banner.jpg">
  <meta name="twitter:card" content="summary_large_image">

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBvVXMxGHHJH2KCGhi5AjJeu-7_48irc1U",
    authDomain: "rugatha-87e15.firebaseapp.com",
    projectId: "rugatha-87e15",
    storageBucket: "rugatha-87e15.firebasestorage.app",
    messagingSenderId: "1022766499204",
    appId: "1:1022766499204:web:a4a4c318e16ce37809c9d1",
    measurementId: "G-KLYZ9WTYK9"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
</head>
<body>
  <div class="page">
    <header class="banner" aria-label="Rugatha banner image">
      <a href="http://rugatha.github.io/web/" class="banner-link" aria-label="前往 Rugatha 首頁">
        <img src="../assets/rugatha-banner.jpg" alt="Rugatha banner" class="banner-logo" loading="lazy">
      </a>
    </header>

    <main class="page-shell">
      <section class="hero">
        <h1>Map of Dranison 卓尼森島地圖</h1>
      </section>

      <section class="map-panel" aria-label="Dranison world map">
        <figure class="map-frame">
          <div id="leaflet-map" class="map-image" role="img" aria-label="卓尼森地圖"></div>
        </figure>
      </section>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const mapElement = document.getElementById('leaflet-map');
    const map = L.map(mapElement, {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomSnap: 0.25
    });

    const pinSvg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14">
        <circle cx="7" cy="7" r="4.5" fill="#ffffff" stroke="#111111" stroke-width="2"/>
      </svg>
    `);
    const pinIcon = L.icon({
      iconUrl: `data:image/svg+xml,${pinSvg}`,
      iconSize: [14, 14],
      iconAnchor: [7, 7],
      popupAnchor: [0, -8]
    });

    const mapImageUrl = 'assets/dranison-map.jpg';
    const image = new Image();
    image.onload = () => {
      const bounds = [[0, 0], [image.naturalHeight, image.naturalWidth]];
      const setMapSize = () => {
        const width = mapElement.getBoundingClientRect().width;
        const height = Math.round(width * (image.naturalHeight / image.naturalWidth));
        mapElement.style.height = `${height}px`;
        map.invalidateSize();
      };
      setMapSize();
      window.addEventListener('resize', setMapSize);
      L.imageOverlay(mapImageUrl, bounds).addTo(map);
      map.fitBounds(bounds, { padding: [0, 0] });
      map.setMinZoom(map.getZoom());
      map.setMaxBounds(bounds);

      const HomeControl = L.Control.extend({
        options: {
          position: 'topleft'
        },
        onAdd() {
          const container = L.DomUtil.create('div', 'leaflet-bar');
          const button = L.DomUtil.create('a', 'leaflet-control-home', container);
          button.href = '#';
          button.title = 'Reset view';
          button.setAttribute('aria-label', 'Reset view');
          button.textContent = '⌂';
          L.DomEvent.disableClickPropagation(button);
          L.DomEvent.on(button, 'click', (event) => {
            L.DomEvent.preventDefault(event);
            map.fitBounds(bounds, { padding: [0, 0] });
          });
          return container;
        }
      });
      map.addControl(new HomeControl());

      fetch('assets/locations.json')
        .then((response) => response.json())
        .then((locations) => {
          locations.forEach((location) => {
            let x = location.x;
            let y = location.y;
            if (x <= 1 && y <= 1) {
              x = x * image.naturalWidth;
              y = y * image.naturalHeight;
            } else if (x <= 100 && y <= 100) {
              x = (x / 100) * image.naturalWidth;
              y = (y / 100) * image.naturalHeight;
            }

            const marker = L.marker([y, x], { title: location.name, icon: pinIcon });
            marker.bindPopup(`<strong>${location.name}</strong>`);
            marker.addTo(map);
          });
        })
        .catch((error) => {
          console.warn('Unable to load map locations.', error);
        });
    };
    image.src = mapImageUrl;
  </script>
</body>
</html>
