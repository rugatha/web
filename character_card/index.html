<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BZZFKMJ65Y"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-BZZFKMJ65Y');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rugatha 角色卡製作器</title>
  <link rel="icon" type="image/png" href="../assets/rugatha-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/rugatha-icon-32.png">
  <link rel="stylesheet" href="../shared/styles/theme.css">
  <link rel="stylesheet" href="styles/style.css">
  <meta property="og:image" content="https://rugatha.github.io/web/assets/rugatha-banner.jpg">
  <meta name="twitter:image" content="https://rugatha.github.io/web/assets/rugatha-banner.jpg">
  <meta name="twitter:card" content="summary_large_image">

</head>
<body>
  <div class="page">
    <header class="banner">
      <img src="../assets/rugatha-banner.jpg" alt="Rugatha banner" class="banner-img">
    </header>

    <main class="layout">
      <section class="panel form-panel">
        <div class="form-actions">
          <button id="lang-toggle" class="btn ghost" type="button">English</button>
          <button id="reset" class="btn ghost" type="button">重設</button>
        </div>
        <h2 id="form-title">角色資訊</h2>
        <div class="field">
          <label for="name"><span class="label-text">姓名</span></label>
          <input id="name" type="text" placeholder="Name" value="Adventurer">
        </div>
        <div class="field">
          <label for="race"><span class="label-text">種族</span></label>
          <select id="race"></select>
          <div class="other-input" id="race-other-wrap" hidden>
            <label for="race-other"><span class="label-text">自訂</span></label>
            <input id="race-other" type="text" placeholder="Custom race">
          </div>
        </div>
        <div class="field">
          <label for="color"><span class="label-text">主色</span></label>
          <div class="color-row">
            <input id="color" type="text" placeholder="#7bdcb5" value="#7bdcb5">
            <input id="color-picker" type="color" value="#7bdcb5" aria-label="Color picker">
          </div>
          <div class="swatches" aria-label="Preset colors">
            <button type="button" class="swatch" data-color="#7bdcb5" style="background:#7bdcb5"></button>
            <button type="button" class="swatch" data-color="#8bc8ff" style="background:#8bc8ff"></button>
            <button type="button" class="swatch" data-color="#ffd166" style="background:#ffd166"></button>
            <button type="button" class="swatch" data-color="#c48bff" style="background:#c48bff"></button>
            <button type="button" class="swatch" data-color="#ff9e9e" style="background:#ff9e9e"></button>
            <button type="button" class="swatch" data-color="#a7f0ba" style="background:#a7f0ba"></button>
          </div>
        </div>
        <div class="field two">
          <div>
            <label for="class1"><span class="label-text">職業</span></label>
            <select id="class1"></select>
            <div class="other-input" id="class1-other-wrap" hidden>
              <label for="class1-other"><span class="label-text">自訂</span></label>
              <input id="class1-other" type="text" placeholder="Custom class">
            </div>
          </div>
          <div>
            <label for="level1"><span class="label-text">等級</span></label>
            <select id="level1"></select>
          </div>
        </div>
        <div class="field checkbox">
          <label>
            <input id="multiclass" type="checkbox">
            <span class="label-text">兼職</span>
          </label>
        </div>
        <div class="field two" id="multiclass-row" hidden>
          <div>
            <label for="class2"><span class="label-text">職業 2</span></label>
            <select id="class2"></select>
            <div class="other-input" id="class2-other-wrap" hidden>
              <label for="class2-other"><span class="label-text">自訂</span></label>
              <input id="class2-other" type="text" placeholder="Custom class">
            </div>
          </div>
          <div>
            <label for="level2"><span class="label-text">等級</span></label>
            <select id="level2"></select>
          </div>
        </div>
        <div class="field two">
          <div>
            <label for="hp"><span class="label-text">生命值上限</span></label>
            <input id="hp" type="number" min="1" max="999" value="20">
          </div>
          <div>
            <label for="ac"><span class="label-text">護甲等級 (AC)</span></label>
            <input id="ac" type="number" min="1" max="30" value="15">
          </div>
        </div>
        <div class="field">
          <label for="pp"><span class="label-text">被動觀察</span></label>
          <input id="pp" type="number" min="1" max="30" value="12">
        </div>
        <fieldset class="field ability-grid">
          <legend class="label-text">能力值</legend>
          <label>STR
            <select data-ability="str"></select>
          </label>
          <label>DEX
            <select data-ability="dex"></select>
          </label>
          <label>CON
            <select data-ability="con"></select>
          </label>
          <label>INT
            <select data-ability="int"></select>
          </label>
          <label>WIS
            <select data-ability="wis"></select>
          </label>
          <label>CHA
            <select data-ability="cha"></select>
          </label>
        </fieldset>
        <fieldset class="field range-group">
          <legend class="label-text">裁切圖片</legend>
          <label><span class="label-text">縮放</span>
            <input id="crop-zoom" type="range" min="1" max="3" step="0.05" value="1">
          </label>
          <label><span class="label-text">水平</span>
            <input id="crop-x" type="range" min="0" max="1" step="0.01" value="0.5">
          </label>
          <label><span class="label-text">縮放</span>
            <input id="crop-y" type="range" min="0" max="1" step="0.01" value="0.5">
          </label>
          <div class="crop-actions">
            <button id="crop-flip" class="btn ghost toggle" type="button" aria-pressed="false">水平翻轉</button>
          </div>
        </fieldset>
      </section>

      <section class="panel preview-panel">
        <div class="preview-header">
          <div>
            <h2 id="preview-title">預覽</h2>
            <p class="download-note" id="download-note">若使用手機Messenger app開啟，建議切換至瀏覽器進行下載</p>
          </div>
          <button id="download" class="btn primary" type="button">下載角色卡圖檔</button>
        </div>
        <div class="upload-box sr-only">
          <label for="image"><span class="label-text">角色圖片</span></label>
          <input id="image" type="file" accept="image/*">
        </div>
        <div class="canvas-wrap">
          <canvas id="card-canvas" width="1200" height="700" aria-label="角色卡預覽"></canvas>
          <img class="dm-overlay" src="../assets/dm-screen.png" alt="DM screen overlay" hidden>
        </div>
      </section>
    </main>
  </div>

  <script src="../shared/rugatha.config.js"></script>
  <script type="module" src="scripts/app.js"></script>
  <script src="../shared/firebase.config.js"></script>
  <script type="module" src="../shared/auth.js"></script>
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      get,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    const firebaseConfig = window.RUGATHA_FIREBASE_CONFIG || null;
    const firebaseDisabled =
      window.RUGATHA_FEATURE_FLAGS && window.RUGATHA_FEATURE_FLAGS.firebaseEnabled === false;
    const ACHIEVEMENTS_CSV_PATH = "../member/achievements.csv";
    const ACHIEVEMENT_CODE = "ach-RYd";

    let auth = null;
    let db = null;
    let currentUser = null;
    let achievementData = null;
    let achievementLoadPromise = null;

    const parseCsv = (text) => {
      const rows = [];
      let row = [];
      let cell = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i += 1) {
        const char = text[i];
        if (inQuotes) {
          if (char === "\"") {
            if (text[i + 1] === "\"") {
              cell += "\"";
              i += 1;
            } else {
              inQuotes = false;
            }
          } else {
            cell += char;
          }
        } else if (char === "\"") {
          inQuotes = true;
        } else if (char === ",") {
          row.push(cell);
          cell = "";
        } else if (char === "\n") {
          row.push(cell);
          rows.push(row);
          row = [];
          cell = "";
        } else if (char !== "\r") {
          cell += char;
        }
      }
      if (cell.length || row.length) {
        row.push(cell);
        rows.push(row);
      }
      return rows;
    };

    const loadAchievementData = async () => {
      if (achievementLoadPromise) return achievementLoadPromise;
      achievementLoadPromise = (async () => {
        try {
          const response = await fetch(ACHIEVEMENTS_CSV_PATH, { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`Failed to load achievements CSV: ${response.status}`);
          }
          const text = await response.text();
          const rows = parseCsv(text);
          if (!rows.length) return null;
          const headers = rows[0].map((header) => String(header || "").trim());
          const target = rows.slice(1).find((row) => row[0] === ACHIEVEMENT_CODE);
          if (!target) return null;
          const record = {};
          headers.forEach((header, index) => {
            record[header] = target[index] ?? "";
          });
          achievementData = {
            achievement: ACHIEVEMENT_CODE,
            flavorZh: record.flavorZh || "",
            flavorEn: record.flavorEn || "",
            rewards: {
              BadgeSTR: Number(record.STR || 0),
              BadgeDEX: Number(record.DEX || 0),
              BadgeCON: Number(record.CON || 0),
              BadgeINT: Number(record.INT || 0),
              BadgeWIS: Number(record.WIS || 0),
              BadgeCHA: Number(record.CHA || 0)
            }
          };
          return achievementData;
        } catch (error) {
          console.error("Failed to load achievement data", error);
          return null;
        }
      })();
      return achievementLoadPromise;
    };

    const showAchievementToast = (flavorZh, flavorEn) => {
      if (!flavorZh && !flavorEn) return;
      if (!document.body) return;
      const styleId = "rugatha-achievement-toast-style";
      if (!document.getElementById(styleId)) {
        const style = document.createElement("style");
        style.id = styleId;
        style.textContent = `
          .achievement-toast-wrap {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 9999;
            display: grid;
            gap: 10px;
            pointer-events: none;
          }
          .achievement-toast {
            min-width: 220px;
            max-width: 320px;
            background: rgba(248, 250, 252, 0.95);
            color: #1b2a26;
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 14px;
            padding: 12px 14px;
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.35);
            display: grid;
            gap: 6px;
            font-size: 0.85rem;
            line-height: 1.4;
            animation: toast-in 200ms ease-out;
          }
          .achievement-toast .toast-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: rgba(27, 42, 38, 0.7);
          }
          @keyframes toast-in {
            from { transform: translateY(6px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);
      }
      let wrap = document.querySelector(".achievement-toast-wrap");
      if (!wrap) {
        wrap = document.createElement("div");
        wrap.className = "achievement-toast-wrap";
        document.body.appendChild(wrap);
      }
      const toast = document.createElement("div");
      toast.className = "achievement-toast";
      const title = document.createElement("div");
      title.className = "toast-title";
      title.textContent = "89e3939662105c31Ff1a";
      toast.appendChild(title);
      if (flavorZh) {
        const zh = document.createElement("div");
        zh.textContent = flavorZh;
        toast.appendChild(zh);
      }
      if (flavorEn) {
        const en = document.createElement("div");
        en.textContent = flavorEn;
        toast.appendChild(en);
      }
      wrap.appendChild(toast);
      window.setTimeout(() => {
        toast.remove();
        if (wrap && !wrap.children.length) {
          wrap.remove();
        }
      }, 4500);
    };

    const resolveMemberId = async (user) => {
      if (!user || !db) return null;
      const defaultId = user.uid;
      try {
        const snapshot = await get(ref(db, `members/${defaultId}`));
        if (snapshot.exists()) {
          const data = snapshot.val() || {};
          return data.memberId || defaultId;
        }
      } catch (error) {
        console.warn("Failed to resolve member id", error);
      }
      return defaultId;
    };

    const awardAchievement = async () => {
      if (!currentUser || !db) return;
      const achievement = await loadAchievementData();
      if (!achievement) return;
      const memberId = await resolveMemberId(currentUser);
      if (!memberId) return;
      const memberRef = ref(db, `members/${memberId}`);
      let awarded = false;
      try {
        const result = await runTransaction(memberRef, (current) => {
          const existing = current || {};
          const existingAchievements = existing.achievements || {};
          if (existingAchievements[achievement.achievement]) {
            return existing;
          }
          awarded = true;
          const nextAchievements = { ...existingAchievements, [achievement.achievement]: true };
          const next = { ...existing, achievements: nextAchievements };
          Object.entries(achievement.rewards || {}).forEach(([key, value]) => {
            const baseValue = Number(existing[key]);
            const safeBase = Number.isFinite(baseValue) ? baseValue : 10;
            const rewardValue = Number.isFinite(value) ? value : 0;
            next[key] = safeBase + rewardValue;
          });
          return next;
        });
        if (result.committed && awarded) {
          showAchievementToast(achievement.flavorZh, achievement.flavorEn);
        }
      } catch (error) {
        console.error("Failed to award achievement", error);
      }
    };

    const setupDownloadTracking = () => {
      const downloadButton = document.getElementById("download");
      if (!downloadButton) return;
      downloadButton.addEventListener("click", () => {
        awardAchievement();
      });
    };

    if (!firebaseDisabled && firebaseConfig) {
      const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);
      onAuthStateChanged(auth, (user) => {
        currentUser = user || null;
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", setupDownloadTracking);
    } else {
      setupDownloadTracking();
    }
  </script>
</body>
</html>
